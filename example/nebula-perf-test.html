<!DOCTYPE html>
<html>
    <head>
        <title>Test</title>
    </head>

    <script src="../src/main.js" type="text/javascript"></script>
    <script type="text/javascript">
        const runPerfTest = function(imgOnCanvas, numSamples) {
            const fragmentShaderSrc = `
                precision mediump float;

                uniform sampler2D uSampler;
                varying vec2 vTextureCoord;
                
                void main(void) {
                    vec4 src = texture2D( uSampler, ( vTextureCoord ) );
                    float grayPx = src.r*0.2126 + src.g*0.7152 + src.b*0.0722;
                    gl_FragColor = vec4(grayPx, grayPx, grayPx, 1);
                }
            `;

            window.runGLSLConversion = function() {
                const metricsMap = new Map();
                metricsMap.set("texImage2D", []);
                metricsMap.set("drawElements", []);
                metricsMap.set("drawImage", []);
                metricsMap.set("createShaderProgram", []);
                metricsMap.set("createRectangleGLModel", []);

                const glslShaderT1 = performance.now();
                output = CanvasImageTransformer.applyGLSLFragmentShader(
                    imgOnCanvas,
                    fragmentShaderSrc,
                    [],
                    metricsMap
                );

                const glslTimeDelta = performance.now() - glslShaderT1;
                metricsMap.set("glslTimeDelta", glslTimeDelta);

                return metricsMap;
                //console.log(`CanvasImageTransformer, grayscale conversion via GLSL fragment shader: ${glslTimeDelta}ms`);         
            }

            window.runCanvas2DConversion = function() {
                const canvas2dT1 = performance.now();
                output = CanvasImageTransformer.toGrayscale(imgOnCanvas);
                const canvas2dTimeDelta = performance.now() - canvas2dT1;
                return canvas2dTimeDelta;
                //console.log(`CanvasImageTransformer, grayscale conversion via pixel manipulation on 2D canvas: ${canvas2dTimeDelta}ms`);
            };

            const glslConversionTimes = [];
            const canvas2dConversionTimes = [];

            const createRectangleGLModelTimes = [];
            const createShaderProgramTimes = [];
            const texImage2DTimes = [];
            const drawElementsTimes = [];
            const drawImageTimes = [];

            for(let i=0; i<numSamples; i++) {
                const metrics = window.runGLSLConversion();
                glslConversionTimes.push(metrics.get("glslTimeDelta"));
                createRectangleGLModelTimes.push(metrics.get("createRectangleGLModel"));
                createShaderProgramTimes.push(metrics.get("createShaderProgram"));
                texImage2DTimes.push(metrics.get("texImage2D"));
                drawElementsTimes.push(metrics.get("drawElements"));
                drawImageTimes.push(metrics.get("drawImage"));
            }

            for(let i=0; i<numSamples; i++) {
                canvas2dConversionTimes.push( window.runCanvas2DConversion() );
            }

            const docImg = document.getElementById('testImage');
            docImg.src = output.toDataURL();

            console.log("glslConversionTimes = \n" + glslConversionTimes.join("\n"));
            console.log("createRectangleGLModelTimes = \n" + createRectangleGLModelTimes.join("\n"));            
            console.log("createShaderProgramTimes = \n" + createShaderProgramTimes.join("\n"));            
            console.log("texImage2DTimes = \n" + texImage2DTimes.join("\n"));
            console.log("drawImageTimes = \n" + drawImageTimes.join("\n"));                        
            console.log("drawElementsTimes = \n" + drawElementsTimes.join("\n"));                        
            console.log("canvas2dConversionTimes = \n" + canvas2dConversionTimes.join("\n"));
        };


        /**
            CanvasImageTransformer.applyGLSLFragmentShader() example
        */
        const img = new Image();
        img.onload = function() {
            const imgOnCanvas = CanvasImageTransformer.imageToCanvas(img, 3864, 3864, true);
            runPerfTest(imgOnCanvas, 25);
        };
        
        img.src = "crab-nebula.jpg";

    </script>


    <body>
        <img id="testImage" src="" />
    </body>

</html>

